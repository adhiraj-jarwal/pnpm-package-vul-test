name: Vulnerability Scanner

on:
  pull_request:
    branches: ['*']
  push:
    branches: ['main']
  workflow_dispatch:
  # Weekly scan on main branch (Monday 3 AM UTC)
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ========== NPM/PNPM Vulnerability Scan ==========
  scan-npm-vulnerabilities:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Detect if npm dependency files changed
      - name: Check for npm dependency changes
        id: npm-changes
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/package.json
            **/pnpm-lock.yaml
            **/package-lock.json
            **/yarn.lock
            pnpm-workspace.yaml

      - name: Skip scan - no npm changes detected
        if: steps.npm-changes.outputs.any_changed != 'true'
        run: |
          echo "âœ… No npm dependency files changed in this PR"
          echo "Skipping npm vulnerability scan"

      - name: Setup Node.js and pnpm
        if: steps.npm-changes.outputs.any_changed == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        if: steps.npm-changes.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        if: steps.npm-changes.outputs.any_changed == 'true'
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        if: steps.npm-changes.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ” Running pnpm audit on npm dependencies..."
          pnpm audit --audit-level=low --json > audit-results.json || true
          echo "Audit completed"

      - name: Setup Python for processing
        if: steps.npm-changes.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Process audit results and post comment
        if: steps.npm-changes.outputs.any_changed == 'true'
        run: |
          python .github/scripts/process-npm-audit.py
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MIN_FAIL_SEVERITY: MODERATE
          # MONITORING MODE: Scanner posts comments but never fails CI
          # Set to 'true' to block PRs with vulnerabilities (enforcement mode)
          ENFORCE_VULNERABILITIES: false

  # ========== Python/UV Vulnerability Scan ==========
  scan-python-vulnerabilities:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Detect if Python dependency files changed
      - name: Check for Python dependency changes
        id: python-changes
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/requirements.txt
            **/pyproject.toml
            **/poetry.lock
            **/uv.lock
            **/Pipfile.lock

      - name: Skip scan - no Python changes detected
        if: steps.python-changes.outputs.any_changed != 'true'
        run: |
          echo "âœ… No Python dependency files changed in this PR"
          echo "Skipping Python vulnerability scan"

      - name: Setup Python
        if: steps.python-changes.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        if: steps.python-changes.outputs.any_changed == 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install pip-audit using uv
        if: steps.python-changes.outputs.any_changed == 'true'
        run: |
          uv pip install --system pip-audit

      - name: Run pip-audit with uv
        if: steps.python-changes.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ” Running pip-audit on Python dependencies (using uv)..."
          # Try different methods based on what files exist
          if [ -f "requirements.txt" ]; then
            pip-audit --requirement requirements.txt --format json > audit-results.json || true
          elif [ -f "pyproject.toml" ]; then
            pip-audit --format json > audit-results.json || true
          elif [ -f "uv.lock" ]; then
            uv pip freeze | pip-audit --requirement /dev/stdin --format json > audit-results.json || true
          else
            echo '{"vulnerabilities": []}' > audit-results.json
          fi
          echo "Audit completed successfully using uv + pip-audit"

      - name: Process audit results and post comment
        if: steps.python-changes.outputs.any_changed == 'true'
        run: |
          python .github/scripts/process-python-audit.py
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MIN_FAIL_SEVERITY: MODERATE
          # MONITORING MODE: Scanner posts comments but never fails CI
          # Set to 'true' to block PRs with vulnerabilities (enforcement mode)
          ENFORCE_VULNERABILITIES: false

  # ========== Go Vulnerability Scan ==========
  scan-go-vulnerabilities:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Detect if Go dependency files changed
      - name: Check for Go dependency changes
        id: go-changes
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/go.mod
            **/go.sum

      - name: Skip scan - no Go changes detected
        if: steps.go-changes.outputs.any_changed != 'true'
        run: |
          echo "âœ… No Go dependency files changed in this PR"
          echo "Skipping Go vulnerability scan"

      - name: Setup Go
        if: steps.go-changes.outputs.any_changed == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install govulncheck
        if: steps.go-changes.outputs.any_changed == 'true'
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        if: steps.go-changes.outputs.any_changed == 'true'
        continue-on-error: true
        run: |
          echo "ðŸ” Running govulncheck on Go modules..."
          # Check if go.mod exists in root or subdirectories
          if [ -f "go.mod" ]; then
            govulncheck -json ./... > go-audit-results.json 2>&1 || true
          else
            echo '{"Vulns": []}' > go-audit-results.json
          fi
          echo "Audit completed"

      - name: Setup Python for processing
        if: steps.go-changes.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Process audit results and post comment
        if: steps.go-changes.outputs.any_changed == 'true'
        run: |
          python .github/scripts/process-go-audit.py
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          MIN_FAIL_SEVERITY: MODERATE
          # MONITORING MODE: Scanner posts comments but never fails CI
          # Set to 'true' to block PRs with vulnerabilities (enforcement mode)
          ENFORCE_VULNERABILITIES: false

  # ========== Scheduled Scans on Main Branch ==========
  scan-vulnerabilities-scheduled:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      # NPM Scan
      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install npm dependencies
        if: hashFiles('**/pnpm-lock.yaml', '**/package-lock.json') != ''
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile || true
          elif [ -f "package-lock.json" ]; then
            npm ci || true
          fi

      - name: Run npm audit
        continue-on-error: true
        run: |
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm audit --audit-level=low --json > npm-audit-results.json || true
          elif [ -f "package-lock.json" ]; then
            npm audit --json > npm-audit-results.json || true
          else
            echo '{"advisories": {}}' > npm-audit-results.json
          fi

      # Python Scan
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install pip-audit using uv
        run: uv pip install --system pip-audit

      - name: Run Python audit with uv
        continue-on-error: true
        run: |
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "uv.lock" ]; then
            pip-audit --format json > python-audit-results.json 2>&1 || echo '{"vulnerabilities": []}' > python-audit-results.json
          else
            echo '{"vulnerabilities": []}' > python-audit-results.json
          fi

      # Go Scan
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run Go audit
        continue-on-error: true
        run: |
          if [ -f "go.mod" ]; then
            govulncheck -json ./... > go-audit-results.json 2>&1 || echo '{"Vulns": []}' > go-audit-results.json
          else
            echo '{"Vulns": []}' > go-audit-results.json
          fi

      # Process results
      - name: Process all audit results
        run: |
          # Count vulnerabilities
          npm_count=0
          python_count=0
          go_count=0
          
          if [ -f "npm-audit-results.json" ]; then
            npm_count=$(python -c "import json; data=json.load(open('npm-audit-results.json')); print(len(data.get('advisories', {})))" 2>/dev/null || echo "0")
          fi
          
          if [ -f "python-audit-results.json" ]; then
            python_count=$(python -c "import json; data=json.load(open('python-audit-results.json')); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
          fi
          
          if [ -f "go-audit-results.json" ]; then
            go_count=$(python -c "import json; data=json.load(open('go-audit-results.json')); print(len(data.get('Vulns', [])))" 2>/dev/null || echo "0")
          fi
          
          total=$((npm_count + python_count + go_count))
          
          echo "NPM vulnerabilities: $npm_count"
          echo "Python vulnerabilities: $python_count"
          echo "Go vulnerabilities: $go_count"
          echo "Total vulnerabilities: $total"
          
          # Create issue if vulnerabilities found
          if [ "$total" -gt "0" ]; then
            cat > issue-body.md <<EOF
          ## ðŸš¨ Weekly Vulnerability Scan: Issues Detected

          The scheduled vulnerability scan found **$total** total vulnerabilities across all package managers.

          ### ðŸ“Š Summary

          - ðŸ“¦ **npm/pnpm:** $npm_count vulnerabilities
          - ðŸ **Python:** $python_count vulnerabilities
          - ðŸ”· **Go:** $go_count vulnerabilities

          ### ðŸ”§ Next Steps

          1. Review the vulnerabilities in the workflow logs
          2. Create PRs to upgrade affected packages
          3. Test thoroughly before merging
          4. Close this issue once resolved

          ### â„¹ï¸ Context

          - **Branch:** main
          - **Scan Date:** $(date -u +"%Y-%m-%d %H:%M UTC")
          - **Workflow:** ${{ github.workflow }}
          - **Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---

          *ðŸ¤– Automated weekly security scan*
          EOF
            
            # Search for existing open issue
            existing_issue=$(gh issue list --label "security,vulnerabilities" --state open --limit 1 --json number --jq '.[0].number' 2>/dev/null || echo "")
            
            if [ -n "$existing_issue" ]; then
              echo "Updating existing issue #$existing_issue"
              gh issue comment "$existing_issue" --body-file issue-body.md
            else
              echo "Creating new issue"
              gh issue create \
                --title "ðŸš¨ Security Vulnerabilities Detected on Main ($(date +%Y-%m-%d))" \
                --body-file issue-body.md \
                --label "security,vulnerabilities,automated"
            fi
          else
            echo "âœ… No vulnerabilities found on main branch"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload audit results
      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-scan-results-${{ github.run_id }}
          path: |
            *-audit-results.json
          retention-days: 30

